<script>
    function initSlack() {
        let url = new URL(window.location.href); 
        let params = {};
        params.code = url.searchParams.get('code');
        params.state = url.searchParams.get('state');
        localStorage.setItem('pre-auth', JSON.stringify(params));
        getToken();
    }

    function getToken() {
        const request = new XMLHttpRequest();
        const client_id = '231613720450.347038352342';
        const client_secret = '0cba2bc4574755e161719c48068e6a2b';
        const auth = JSON.parse(localStorage.getItem('pre-auth'));
        request.open('GET', 'https://slack.com/api/oauth.access?client_id='+client_id+'&client_secret='+client_secret+'&code='+auth.code, true);
        request.send(null);
        request.onreadystatechange = function() {
            if (request.readyState == 4 && request.status == 200) {
                localStorage.setItem('auth', request.responseText);
                const user = JSON.parse(localStorage.getItem('auth')).user_id;
                const token = JSON.parse(localStorage.getItem('auth')).access_token;
                request.open('GET', 'https://slack.com/api/users.info?user=' + user + '&token=' + token, true);
                request.send(null);
                request.onreadystatechange = function() {
                    if (request.readyState == 4 && request.status == 200) {
                        localStorage.setItem('user', request.responseText);
                        location.href = '/slack-manager-v2';
                    }
                }
            }
        };
    }

    initSlack();
</script>